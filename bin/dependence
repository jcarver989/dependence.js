#!/usr/bin/env ruby
require 'rubygems'
require 'fileutils'
require 'coffee-script'
require 'dependence'
require 'optparse'

class DependenceCompiler
  def initialize(config)
    @config = config
    @src_glob = "**/*"
    @concatenator = Dependence::Concatenator.new(
      :load_path => @config[:src_dir]
    )
  end

  def compile
    begin
      @config[:watch] ? compile_with_watcher : run_compile
    rescue => e
      puts Colors.red("Error during processing, exiting.")
      raise e
    end
  end

  private

  def compile_with_watcher
    FileWatcher.new(:load_path => @config[:src_dir],  :glob_str => @src_glob) do
      print "File change detected. Recompiling... "
      begin
        run_compile
        puts "done."
      rescue => e
        puts Colors.red("Error: " + e.to_s)
      end
    end
  end

  def run_compile
    @concatenator.concat do |module_name, module_content|
      stdout_compile_msg(module_name)
      FileUtils::mkdir_p @config[:output]

      compiled = module_content
      compiled = ModuleInjector.modularize(module_name, module_content) unless @config[:bare]

      output = File.join(@config[:output], "#{module_name}.js")
      File.open(output, 'w') { |f| f.syswrite compiled }

      stdout_compile_complete_msg(module_name, output)
      compress_code(output) if @config[:compress]
    end
  end

  def stdout_compile_msg(module_name)
    puts Colors.green("Detected Module: #{module_name}")
  end

  def stdout_compile_complete_msg(module_name, output)
    puts Colors.green("Compiled #{module_name} to #{output}")
  end

  def compress_code(source_file)
    JsCompiler.new(source_file).compile
  end
end


options = {
  :output   => ".",
  :watch    => false,
  :bare     => false,
  :compress => false
}

OptionParser.new do |opts|
  opts.banner = "Usage: src_dir [options]"

  opts.on("-o", "--output DIR", "Output directory, defaults to '.'") do |dir|
    options[:output] = dir
  end

  opts.on("-w", "--watch", "Watch src_dir for changes and recompile") do |bool|
    options[:watch] = bool
  end

  opts.on("-b", "--bare", "Do not wrap modules in closures with export var") do |bool|
    options[:bare] = bool
  end

  opts.on("-c", "--compress", "Compress output with Googles Closure compiler") do |bool|
    options[:compress] = bool
  end

end.parse(ARGV)

if ARGV.length < 1
  puts "You need a src directory to compile from!"
  exit 1
elsif !File.directory? ARGV[0]
  puts "#{ARGV[0]} is not a directory!"
  exit 1
end

options[:src_dir] = ARGV[0]


compiler = DependenceCompiler.new options
compiler.compile
